static int  ParseSSA( demux_t *p_demux, subtitle_t *p_subtitle )
{
    demux_sys_t *p_sys = p_demux->p_sys;
    text_t      *txt = &p_sys->txt;
    char buffer_text[ 10 * MAX_LINE + 1];
    char buffer_text2[ 10 * MAX_LINE + 1];
    char *s;
    int64_t     i_start;
    int64_t     i_stop;
    p_subtitle->i_start = 0;
    p_subtitle->i_stop  = 0;
    p_subtitle->psz_text = NULL;
    for( ;; )
    {
        int h1, m1, s1, c1, h2, m2, s2, c2;
        if( ( s = TextGetLine( txt ) ) == NULL )
        {
            return( VLC_EGENERIC );
        }
        p_subtitle->psz_text = malloc( strlen( s ) );
        /* We expect (SSA2-4):
         * Format: Marked, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
         * Dialogue: Marked=0,0:02:40.65,0:02:41.79,Wolf main,Cher,0000,0000,0000,,Et les enregistrements de ses ondes delta ?
         *
         * SSA-1 is similar but only has 8 commas up untill the subtitle text. Probably the Effect field is no present, but not 100 % sure.
         */
        /* For ASS:
         * Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
         * Dialogue: Layer#,0:02:40.65,0:02:41.79,Wolf main,Cher,0000,0000,0000,,Et les enregistrements de ses ondes delta ?
         */
        if( sscanf( s,
                    "Dialogue: %[^,],%d:%d:%d.%d,%d:%d:%d.%d,%81920[^\r\n]",
                    buffer_text2,
                    &h1, &m1, &s1, &c1,
                    &h2, &m2, &s2, &c2,
                    buffer_text ) == 10 )
        {
            i_start = ( (int64_t)h1 * 3600*1000 +
                        (int64_t)m1 * 60*1000 +
                        (int64_t)s1 * 1000 +
                        (int64_t)c1 * 10 ) * 1000;
            i_stop  = ( (int64_t)h2 * 3600*1000 +
                        (int64_t)m2 * 60*1000 +
                        (int64_t)s2 * 1000 +
                        (int64_t)c2 * 10 ) * 1000;
            /* The dec expects: ReadOrder, Layer, Style, Name, MarginL, MarginR, MarginV, Effect, Text */
            /* (Layer comes from ASS specs ... it's empty for SSA.) */
            if( p_sys->i_type == SUB_TYPE_SSA1 )
            {
                sprintf( p_subtitle->psz_text,
                         ",%s", strdup( buffer_text) ); /* SSA1 has only 8 commas before the text starts, not 9 */
            }
            else
            {
                sprintf( p_subtitle->psz_text,
                         ",,%s", strdup( buffer_text) ); /* ReadOrder, Layer, %s(rest of fields) */
            }
            p_subtitle->i_start = i_start;
            p_subtitle->i_stop = i_stop;
            return 0;
        }
        else
        {
            /* All the other stuff we add to the header field */
            if( p_sys->psz_header != NULL )
            {
                if( !( p_sys->psz_header = realloc( p_sys->psz_header,
                          strlen( p_sys->psz_header ) + 1 + strlen( s ) + 2 ) ) )
                {
                    msg_Err( p_demux, "out of memory");
                    return VLC_ENOMEM;
                }
                p_sys->psz_header = strcat( p_sys->psz_header,  s );
                p_sys->psz_header = strcat( p_sys->psz_header, "\n" );
            }
            else
            {
                if( !( p_sys->psz_header = malloc( strlen( s ) + 2 ) ) )
                {
                    msg_Err( p_demux, "out of memory");
                    return VLC_ENOMEM;
                }
                p_sys->psz_header = s;
                p_sys->psz_header = strcat( p_sys->psz_header, "\n" );
            }
        }
    }
}
